<style>

body {
  font: 12px 'Lucida Grande', sans-serif;
  margin: 20px;
}

textarea {
  font: 12px Monaco, monospace;
}

div {
  display: inline-block;
  vertical-align: top;
  margin: 20px;
}

#compileTime {
  float: right;
}

label {
  cursor: default;
  -webkit-user-select: none;
  -moz-user-select: -moz-none;
}

</style>
<div>
  <h2>Input</h2>
  <textarea id="input" rows="10" cols="80" spellcheck="false" autofocus></textarea>
  <p>
    <span id="compileTime">Loading...</span>
    Target:
    <label><input type="radio" name="target" id="targetJS" checked> JavaScript</label>
    <label><input type="radio" name="target" id="targetCS"> C#</label>
    <br>
    <label><input type="checkbox" id="optimize"> Optimize</label>
    <label><input type="checkbox" id="minify"> Minify</label>
  </p>
</div>
<div>
  <h2>Log</h2>
  <textarea id="outputLog" rows="10" cols="80" spellcheck="false" readonly></textarea>
</div>
<div>
  <h2>Tree</h2>
  <textarea id="outputTree" rows="20" cols="80" spellcheck="false" readonly></textarea>
</div>
<div>
  <h2>Code</h2>
  <textarea id="outputCode" rows="20" cols="80" spellcheck="false" readonly></textarea>
</div>
<script src="../../build/debug/skewc.js"></script>
<script>

function compile() {
  var start = now();
  var target =
    targetJS.checked ? 'js' :
    targetCS.checked ? 'cs' :
    null;
  if (input.value === oldInput &&
      optimize.checked === oldOptimize &&
      minify.checked === oldMinify &&
      target === oldTarget) {
    return;
  }
  oldInput = input.value;
  localStorage.optimize = oldOptimize = optimize.checked;
  localStorage.minify = oldMinify = minify.checked;
  localStorage.target = oldTarget = target;
  outputLog.value = outputTree.value = outputCode.value = '';
  try {
    var compiler = new Compiler();
    var options = new CompilerOptions();
    options.jsMinify = options.jsMangle = oldMinify;
    options.removeAsserts = oldOptimize;
    options.foldAllConstants = oldOptimize;
    options.inlineAllFunctions = oldOptimize;
    options.convertAllInstanceToStatic = oldOptimize;
    options.targetFormat =
      oldTarget === 'js' ? TargetFormat.JAVASCRIPT :
      oldTarget === 'cs' ? TargetFormat.CSHARP :
      null;
    options.inputs.push(new Source('<stdin>', oldInput));
    var result = compiler.compile(options);
    outputLog.value = compiler.log.toString();
    if (result.program !== null && result.program.children.length === 2) {
      outputTree.value = lisp.dump(result.program.children[1]);
    }
    outputCode.value = result.outputs.map(function(output) { return output.contents; }).join('');
  } catch (e) {
    outputLog.value = e.stack || e;
  }
  compileTime.innerHTML = 'Compile time: ' + +(now() - start).toFixed(1) + 'ms';
}

var now = this.performance && performance.now
  ? function() { return performance.now(); }
  : function() { return +new Date; };

var oldInput = null;
var oldOptimize = null;
var oldMinify = null;
var oldTarget = null;
optimize.checked = localStorage.optimize === 'true';
minify.checked = localStorage.minify === 'true';
targetJS.checked = localStorage.target === 'js' || !localStorage.target;
targetCS.checked = localStorage.target === 'cs';
input.oninput = input.onchange = optimize.onchange = minify.onchange = targetJS.onchange = targetCS.onchange = compile;
compile();

</script>
