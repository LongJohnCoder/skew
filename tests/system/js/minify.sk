namespace js { void testMinify() {

testJS("
export void foo() {
  for (;;) {}
}
", "
(function(){foo=function(){for(;;);}}());
").release();

testJS("
export class Foo {}
in Foo {
  Foo foo = null;
  Foo bar = null;
}
", "
(function(){Foo=function(){this.a=this.b=null}}());
").release();

testJS("
export class Foo {}
in Foo {
  var xa = 0;
  var xb = false;
  var xc = 0;
  var xd = 0;
  var xe = 0;
  var xf = false;
  var xg = false;
  var xh = 0;
}
", "
(function(){Foo=function(){this.a=0,this.b=!1,this.c=this.d=this.e=0,this.f=this.g=!1,this.h=0}}());
").release();

testJS("
export int foo(StringMap<int> map) {
  return map.get(\"x\") + map.get(\"_\") + map.get(\"x\") + map.get(\"0\") + map.get(\"x0\") + map.get(\"if\");
}
", "
(function(){function b(){this.a=Object.create(null)}foo=function(a){return ((((a.a.x+a.a._|0)+a.a.x|0)+a.a['0']|0)+a.a.x0|0)+a.a['if']|0}}());
").release();

testJS("
export void foo(StringMap<int> map) {
  map.set(\"x\", 0);
  map.set(\"_\", 0);
  map.set(\"x\", 0);
  map.set(\"0\", 0);
  map.set(\"x0\", 0);
  map.set(\"if\", 0);
}
", "
(function(){function b(){this.a=Object.create(null)}foo=function(a){a.a.x=a.a._=a.a.x=a.a['0']=a.a.x0=a.a['if']=0}}());
").release();

testJS("
export void foo() {
  var map = StringMap<bool>();
  bool a;
  a = false;
  map.set(\"a\", false);
  a = true;
  map.set(\"a\", true);
}
", "
(function(){function c(){this.a=Object.create(null)}foo=function(){var a=new c(),b=!1;b=a.a.a=!1,b=a.a.a=!0}}());
").release();

testJS("
export void foo() {
  do {} while (true);
}
", "
(function(){foo=function(){do;while(!0)}}());
").release();

testJS("
import void x();
export void foo() {
  do { x(); } while (true);
}
", "
(function(){foo=function(){do x();while(!0)}}());
").release();

testJS("
import void x();
export void foo() {
  do { x(); break; } while (true);
}
", "
(function(){foo=function(){do{x();break}while(!0)}}());
").release();

testJS("
class Foo {
  int foo;
}
class Bar {
  int bar;
}
export int foo() {
  return Foo(100).foo + Bar(200).bar;
}
", "
(function(){function b(a){this.a=a}function c(a){this.a=a}foo=function(){return new b(100).a+new c(200).a|0}}());
").release();

testJS("
class Foo {
  int foo;
}
class Bar : Foo {
  int bar;
}
export int foo() {
  return Foo(100).foo + Bar(200, 300).foo;
}
", "
(function(){function $e(d,b){d.prototype=Object.create(b.prototype);d.prototype.constructor=d}function c(a){this.a=a}function d(a,b){c.call(this,a),this.b=b}$e(d,c);foo=function(){return new c(100).a+new d(200,300).a|0}}());
").release();

testJS("
import int a();
export int foo(int x) {
  return a() + x;
}
", "
(function(){foo=function(b){return a()+b|0}}());
").release();

testJS("
import namespace a {
  int b();
}
export int foo(int b) {
  return a.b() + b;
}
", "
(function(){foo=function(b){return a.b()+b|0}}());
").release();

testJS("
export void foo(int foo) { int bar, baz; }
export void bar(int foo, int bar) { int baz; }
export void baz(int foo, int bar, int baz) {}
", "
(function(){foo=function(a){var b=0,c=0};bar=function(a,b){var c=0};baz=function(a,b,c){}}());
").release();

testJS("
export int foo() {
  return `0` in 1;
}
", "
(function(){foo=function(){return 0 in 1}}());
").release();

testJS("
export int foo(int foo) {
  return foo + +1;
}
", "
(function(){foo=function(a){return a+1|0}}());
").release();

testJS("
export int foo(int foo) {
  return foo - -1;
}
", "
(function(){foo=function(a){return a+1|0}}());
").release();

testJS("
import void x();
export int foo() {
  x();
  return 1;
}
", "
(function(){foo=function(){return x(),1}}());
").release();

testJS("
import void x();
export int foo() {
  x();
  x();
  return 1;
}
", "
(function(){foo=function(){return x(),x(),1}}());
").release();

testJS("
export int foo(int foo) {
  if (foo < 0) return -1;
  else if (foo > 0) return 1;
  else return 0;
}
", "
(function(){foo=function(a){return a<0?-1:a>0?1:0}}());
").release();

testJS("
export int foo(int foo) {
  if (foo < 0) return -1;
  if (foo > 0) return 1;
  return 0;
}
", "
(function(){foo=function(a){return a<0?-1:a>0?1:0}}());
").release();

testJS("
import void y();
export int foo(int x) {
  if (x < 0) {
    y();
    return 1;
  }
  return 2;
}
", "
(function(){foo=function(a){return a<0?(y(),1):2}}());
").release();

testJS("
export int foo() {
  int foo;
  int bar;
  return foo + bar;
}
", "
(function(){foo=function(){var a=0,b=0;return a+b|0}}());
").release();

testJS("
const bool bar = false;
export int foo(int y) {
  if (y < 0) {
    return -y;
  } else if (bar) {
    return 100;
  }
  return y;
}
", "
(function(){foo=function(a){return a<0?-a|0:a}}());
").release();

testJS("
export int foo(int y) {
  if (y > 0) y++;
  else if (y < 0) y += 2;
  else y--;
  return y;
}
", "
(function(){foo=function(a){return a=(a>0?a+1:a<0?a+2:a-1)|0,a}}());
").release();

testJS("
export int foo(int x, int y) {
  if (x < 0) {
    x++;
    y--;
  } else if (y < 0) {
    x -= y;
  } else {
    x--;
    y++;
  }
  return y;
}
", "
(function(){foo=function(a,b){return a<0?(a=a+1|0,b=b-1|0):b<0?a=a-b|0:(a=a-1|0,b=b+1|0),b}}());
").release();

testJS("
export bool foo(int x, int y) {
  var bar = x == 0 && y != 0;
  if (x == 0 && y != 0) return true;
  else return bar;
}
", "
(function(){foo=function(a,b){var c=a===0&&b!==0;return !a&&b?!0:c}}());
").release();

testJS("
export bool foo(float x, double y) {
  var bar = x == 0 && y != 0;
  if (x == 0 && y != 0) return true;
  else return bar;
}
", "
(function(){foo=function(a,b){var c=a===0&&b!==0;return a===0&&b!==0?!0:c}}());
").release();

testJS("
import class Foo { Foo y(); }
import Foo x;
export bool foo() {
  var bar = x != null && x.y() == null;
  if (x != null && x.y() == null) return true;
  else return bar;
}
", "
(function(){foo=function(){var a=x!==null&&x.y()===null;return x&&!x.y()?!0:a}}());
").release();

testJS("
export bool foo(string x) {
  var bar = x == \"\" || x.slice(1, 2) == \"\";
  if (x == \"\" || x.slice(1, 2) == \"\") return true;
  else return bar;
}
", "
(function(){foo=function(a){var b=a===''||a.slice(1,2)==='';return !a||!a.slice(1,2)?!0:b}}());
").release();

testJS("
import bool x();
import void y();
export void foo() {
  if (x()) {
    y();
    if (x()) {
      y();
      if (x()) y();
    }
  }
}
", "
(function(){foo=function(){x()&&(y(),x()&&(y(),x()&&y()))}}());
").release();

testJS("
import void x();
import void y();
export void foo(int a) {
  if (a < 1) x();
  else if (a < 2) {}
  else y();
}
", "
(function(){foo=function(a){a<1?x():a>1&&y()}}());
").release();

testJS("
export int foo(int a, int b) {
  return a != b ? 1 : 2;
}
", "
(function(){foo=function(a,b){return a^b?1:2}}());
").release();

testJS("
import void b();
export void foo(bool a) {
  if (a) b();
}
", "
(function(){foo=function(a){a&&b()}}());
").release();

testJS("
import void b();
export void foo(bool a) {
  if (!a) b();
}
", "
(function(){foo=function(a){a||b()}}());
").release();

testJS("
import void b();
export int foo(bool a) {
  if (!a) {
    b();
    return 1;
  } else {
    return 2;
  }
}
", "
(function(){foo=function(a){return a?2:(b(),1)}}());
").release();

testJS("
export int foo(bool a) {
  return !a ? 1 : 2;
}
", "
(function(){foo=function(a){return a?2:1}}());
").release();

testJS("
import int y();
import int z();
export int foo(int x) {
  return x == 0 ? y() : z();
}
", "
(function(){foo=function(a){return a?z():y()}}());
").release();

testJS("
import void c();
import void d();
export void foo(Foo a, Foo b) {
  if (a == b) c();
  else d();
}
enum Foo {}
", "
(function(){foo=function(a,b){a^b?d():c()}}());
").release();

testJS("
export int foo(int x) {
  int y;
  switch (x) {
    case 1 { y = 1; }
    case 2 { y = 2; }
  }
  return y;
}
", "
(function(){foo=function(b){var a=0;switch(b){case 1:a=1;break;case 2:a=2}return a}}());
").release();

testJS("
export bool foo(int a) {
  return a >= 5 && a <= 8;
}
export bool bar(int a) {
  return 5 <= a && 8 >= a;
}
", "
(function(){foo=function(a){return a>4&&a<9};bar=function(a){return 4<a&&9>a}}());
").release();

testJS("
import void y();
export void foo(bool x) {
  if (x) {
    y();
    return;
  }
}
", "
(function(){foo=function(a){a&&y()}}());
").release();

testJS("
import void y();
export void foo(bool x) {
  if (x) return;
  y();
  y();
}
", "
(function(){foo=function(a){a||(y(),y())}}());
").release();

testJS("
import void y();
export void foo(bool x) {
  if (x) return;
  y();
  if (x) return;
  y();
}
", "
(function(){foo=function(a){a||(y(),a||y())}}());
").release();

testJS("
import void z();
export void foo(bool x, bool y) {
  if (x) {
    if (y) return;
    z();
    z();
  }
}
", "
(function(){foo=function(a,b){a&&(b||(z(),z()))}}());
").release();

testJS("
import void z();
export void foo(bool x, bool y) {
  if (x) {
    if (y) return;
    z();
    z();
  }
  z();
}
", "
(function(){foo=function(a,b){if(a){if(b)return;z(),z()}z()}}());
").release();

testJS("
import void y();
export void foo(bool x) {
  if (x) {
    y();
    return;
  }
  y();
  y();
}
", "
(function(){foo=function(a){a?y():(y(),y())}}());
").release();

testJS("
import void z();
export void foo(bool x, bool y) {
  while (x) {
    if (y) {
      z();
      continue;
    }
  }
}
", "
(function(){foo=function(a,b){while(a)b&&z()}}());
").release();

testJS("
import void z();
export void foo(bool x, bool y) {
  while (x) {
    if (y) return;
    z();
    z();
  }
}
", "
(function(){foo=function(a,b){while(a){if(b)return;z(),z()}}}());
").release();

testJS("
import void z();
export void foo(bool x, bool y) {
  while (x) {
    if (y) continue;
    z();
    z();
  }
}
", "
(function(){foo=function(a,b){while(a)b||(z(),z())}}());
").release();

testJS("
import void z();
export void foo(bool x, bool y) {
  while (x) {
    if (y) continue;
    z();
    if (y) continue;
    z();
  }
}
", "
(function(){foo=function(b,a){while(b)a||(z(),a||z())}}());
").release();

testJS("
import void z();
export void foo(bool x, bool y) {
  while (x) {
    if (y) {
      z();
      if (y) continue;
      z();
      z();
    }
  }
}
", "
(function(){foo=function(b,a){while(b)a&&(z(),a||(z(),z()))}}());
").release();

testJS("
import void z();
export void foo(bool x, bool y) {
  while (x) {
    if (y) {
      z();
      if (y) continue;
      z();
      z();
    }
    z();
  }
}
", "
(function(){foo=function(b,a){while(b){if(a){z();if(a)continue;z(),z()}z()}}}());
").release();

testJS("
import void z();
export void foo(bool x, bool y) {
  while (x) {
    if (y) {
      z();
      continue;
    }
    z();
    z();
  }
}
", "
(function(){foo=function(a,b){while(a)b?z():(z(),z())}}());
").release();

testJS("
class Foo {
  int foo = 0;
}
export void foo() {
  Foo().foo++;
  Foo().foo++;
}
", "
(function(){function c(){this.a=0}foo=function(){var a;a=new c(),a.a=a.a+1|0;var b;b=new c(),b.a=b.a+1|0}}());
").release();

testJS("
export int foo(int a, int b) { return a * b; }
", "
(function(){var $i=Math.imul||function(a,b){var ah=a>>>16,al=a&65535,bh=b>>>16,bl=b&65535;return al*bl+(ah*bl+al*bh<<16)|0};foo=function(a,b){return $i(a,b)}}());
").release();

testJS("
class Foo {
  virtual void foo() {}
}
class Bar : Foo {
  override void foo() {}
}
class Baz : Foo {
  override void foo() {}
}
export void test() {
  Bar().foo();
}
", "
(function(){function $e(d,b){d.prototype=Object.create(b.prototype);d.prototype.constructor=d}function b(){}function c(){b.call(this)}$e(c,b);c.prototype.a=function(){};test=function(){new c().a()}}());
").release();

testJS("
interface IFoo {
  virtual void foo();
}
class Bar : IFoo {
  override void foo() {}
}
class Baz : IFoo {
  override void foo() {}
}
export void test() {
  ((IFoo)Bar()).foo();
}
", "
(function(){function c(){}c.prototype.a=function(){};test=function(){new c().a()}}());
").release();

testJS("
import void bar(int foo);
export void foo() {
  var n = 10;
  for (var i = 0; i < n; i++) {
    bar(i);
  }
}
", "
(function(){foo=function(){for(var b=10,a=0;a<b;a=a+1|0)bar(a)}}());
").release();

testJS("
export List<double> foo(float x) {
  return [
    - -x,
    x - -2,
    x - -2.0,
    x - -2.5,
    x - -2.0f,
    x - -2.5f,
    x - -math.INFINITY,
  ];
}
", "
(function(){foo=function(a){return [- -a,a- -2,a- -2,a- -2.5,a- -2,a- -2.5,a- -Infinity]}}());
").release();

testJS("
import void bar();
export void foo(int x) {
  switch (x) {
    case 0 {}
    default { bar(); }
  }
}
", "
(function(){foo=function(a){switch(a){case 0:break;default:bar()}}}());
").release();

testJS("
export void foo(int x) {
  switch (x) {
    case 0 {}
    default {}
  }
}
", "
(function(){foo=function(a){}}());
").release();

testJS("
import int bar();
export void foo() {
  switch (bar()) {
    case 0 {}
    default {}
  }
}
", "
(function(){foo=function(){bar()}}());
").release();

testJS("
import void bar();
export void foo(int x) {
  switch (x) {
    case 0 { bar(); }
    default {}
  }
}
", "
(function(){foo=function(a){switch(a){case 0:bar()}}}());
").release();

testJS("
import bool bar();
import bool baz();
export bool foo() {
  if (bar()) return true;
  if (baz()) return true;
  return false;
}
", "
(function(){foo=function(){return bar()||baz()?!0:!1}}());
").release();

testJS("
export bool foo(bool bar, bool baz) {
  if (bar) return true;
  if (baz) return true;
  return false;
}
", "
(function(){foo=function(a,b){return a||b?!0:!1}}());
").release();

testJS("
export bool foo(bool bar, bool baz) {
  if (bar) return true;
  if (baz) return true;
  return true;
}
", "
(function(){foo=function(a,b){return !0}}());
").release();

testJS("
import bool bar();
import bool baz();
export bool foo() {
  if (bar()) return true;
  if (baz()) return true;
  return true;
}
", "
(function(){foo=function(){return bar()?!0:(baz(),!0)}}());
").release();

testJS("
export List<int> foo(int x) {
  return [
    x + 0,
    0 + x,

    x + -2,
    2 + -x,
    -x + 2,
    -2 + x,

    x + 1 + 2,
    x + 1 - 2,
    x - 1 + 2,
    x - 1 - 2,

    1 + x + 2,
    1 + x - 2,
    1 - x + 2,
    1 - x - 2,

    1 + 2 + x,
    1 + 2 - x,
    1 - 2 + x,
    1 - 2 - x,
  ];
}
", "
(function(){foo=function(a){return [a,a,a-2|0,2-a|0,2-a|0,a-2|0,a+3|0,a-1|0,a+1|0,a-3|0,3+a|0,a-1|0,3-a|0,-1-a|0,3+a|0,3-a|0,a-1|0,-1-a|0]}}());
").release();

testJS("
export List<double> foo(double x, bool y) {
  return [
    // These need spaces
    1 - (-x) * 2,
    1 + (+x) * 2,
    1 + (double)y * 2,
    1 - (-x) * 2 / 3,
    1 + (+x) * 2 / 3,
    1 + (double)y * 2 / 3,

    // These should not have spaces
    (-x) * 2 - 1,
    (+x) * 2 + 1,
    (double)y * 2 + 1,
     1 - 2 * (-x),
    1 + 2 * (+x),
    1 + 2 * (double)y,
 ];
}
", "
(function(){foo=function(a,b){return [1- -a*2,1+ +a*2,1+ +b*2,1- -a*2/3,1+ +a*2/3,1+ +b*2/3,-a*2-1,+a*2+1,+b*2+1,1-2*-a,1+2*+a,1+2*+b]}}());
").release();

testJS("
export `var` foo() {
  return {
    \"abc\": 0,
    \"456\": 0,
    \"x y\": 0,
    \"-1\": 0,
    \"01\": 0,
    \"$\": 0,
    \"_\": 0,
  };
}
", "
(function(){foo=function(){return {abc:0,456:0,'x y':0,-1:0,'01':0,$:0,_:0}}}());
").release();

testJS("
export string foo(Foo foo) { return foo.toString(); }
enum Foo { A, B, C, D, E, F }
", "
(function(){foo=function(a){return c[a]};var c='A B C D E F'.split(' ')}());
").release();

testJS("
export string foo(Foo foo) { return foo.toString(); }
enum Foo { A, B, C, D, E }
", "
(function(){foo=function(a){return c[a]};var c=['A','B','C','D','E']}());
").release();

testJS("
export var foo = [\"a\", \"b\", \"c\", \"d\", \"e\", \"f\"];
", "
(function(){foo='a b c d e f'.split(' ')}());
").release();

testJS("
export var foo = [\"a\", \" \", \"c\", \" \", \"e\", \" \"];
", "
(function(){foo='a; ;c; ;e; '.split(';')}());
").release();

testJS("
export var foo = [\" \", \";\", \",\", \"{\", \"}\", \" \"];
", "
(function(){foo=[' ',';',',','{','}',' ']}());
").release();

testJS("
export bool foo(`var` foo) {
  return foo is `Array`;
}
", "
(function(){foo=function(a){return a instanceof Array}}());
").release();

testJS("
export List<bool> foo(`var` foo) {
  return [
    !(foo || 0),
    !(foo || 1),
    !(foo || false),
    !(foo || true),
    !(foo || null),
    !(foo || math.NAN),
    !(foo || math.INFINITY),
  ];
}
", "
(function(){foo=function(a){return [!a,!(a||1),!a,!(a||!0),!a,!a,!(a||Infinity)]}}());
").release();

// This must not become +foo because false and NaN give different results
testJS("
export double foo(`var` foo) {
  return +(foo || null);
}
", "
(function(){foo=function(a){return +(a||null)}}());
").release();

testJS("
export List<int> foo(`var` foo) {
  return [
    ~(foo || 0),
    ~(foo || 1),
    (foo || 0) | 0,
    (foo || 1) | 0,
    (foo || false) ^ 0,
    (foo || true) ^ 0,
    (foo || null) & 0,
    (foo || math.NAN) & 0,
    (foo || math.INFINITY) & 0,
  ];
}
", "
(function(){foo=function(a){return [~a,~(a||1),a|0,(a||1)|0,a^0,(a||!0)^0,a&0,a&0,(a||Infinity)&0]}}());
").release();

testJS("
export List<bool> foo(bool foo) {
  return [
    !foo,
    !!foo,
    !`window`.foo,
    !!`window`.foo,
  ];
}
", "
(function(){foo=function(a){return [!a,a,!window.foo,!!window.foo]}}());
").release();

testJS("
enum Foo { FOO }
class Bar { static var foo = 0; }
export int foo() { return Foo.FOO + Bar.foo; }
", "
(function(){var Foo={FOO:0};function Bar(){}foo=function(){return Foo.FOO+Bar.foo|0};Bar.foo=0}());
").minify();

testJS("
enum Foo { FOO }
class Bar { static var foo = 0; }
export int foo() { return Foo.FOO + Bar.foo; }
", "
(function() {
  var a = 0;
  function d() {
  }
  foo = function() {
    return a + b | 0;
  };
  var b = 0;
}());
").mangle();

testJS("
enum Foo { FOO }
class Bar { static var foo = 0; }
export int foo() { return Foo.FOO + Bar.foo; }
", "
(function(){var a=0;function d(){}foo=function(){return a+b|0};var b=0}());
").minify().mangle();

testJS("
export enum Foo { FOO }
class Bar { static var foo = 0; }
export int foo() { return Foo.FOO + Bar.foo; }
", "
(function(){Foo={FOO:0};function b(){}foo=function(){return Foo.FOO+a|0};var a=0}());
").minify().mangle();

}}
